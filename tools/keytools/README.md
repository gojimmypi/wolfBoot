# Key Tools for signing and key generation

## Sign

See documentation in [docs/Signing.md](../../docs/Signing.md).

## KeyGen and KeyStore

See documentation [docs/keystore.md](../../docs/keystore.md).

## Flash OTP

Pack public keys into a single binary (`otp.bin`) formatted the way wolfBoot expects for
provisioning the device’s OTP/NVM keystore. No signing, no encryption—just a correctly laid-out image
with a header plus fixed-size "slots" for each key.

See documentation [docs/flash-OTP.md](../../docs/flash-OTP.md).


## Quick Start (Linux)

```
make wolfboot_signing_private_key.der SIGN=ED25519

# or

./tools/keytools/keygen --ed25519 -g wolfboot_signing_private_key.der
```

## Generated Keystore Files

Unless otherwise specified the `keygen` app will create:

1. `./wolfboot_signing_private_key.der` - the private key used for signing.
2. `./keystore.der` - the public key.
3. `src/keystore.c` - the public key, converted to c array.

Common pitfalls: mismatched keystore files in different directories. There should be exactly one
instance of each of the above files in the build tree.

The `./tools/scripts/keystore_file_check.sh` may be helpful.


## Strip wolfBoot header

The generated `keystore.der` has an extra 16 bytes of header, can be stripped like this:

```text
dd if=tools/keytools/keystore.der of=raw_xy.bin bs=1 skip=16
64+0 records in
64+0 records out
64 bytes copied, 0.0032417 s, 19.7 kB/s
```

## Strip wolfBoot header from generated public key, convert public key to new SPKI DER file.


The SPKI-format generated by this script can be used to verify an image with `image-peek.py`

```python
./tools/scripts/wolfboot-der-to-spki.py ./tools/keytools/keystore.der
```


## Image Peek

See the [./tools/scripts/image-peek.py](../scripts/image-peek.py).

```
usage: image-peek.py [-h] [--header-size HEADER_SIZE] [--dump-payload OUT]
                     [--verify-hash] [--verify-sig PUBKEY] [--alg {ecdsa-p256,ed25519}] image
```

##

The wolfBoot SPKI DER file can be used to verify an image:

```python
./tools/scripts/image-peek.py ./keytools_test_v1_signed.bin --verify-sig ./tools/keytools/keystore_spki.der --alg ecdsa-p256
```

## Local Visual Studio Projects

There are three projects to:

1. Generate a new signing key
2. Sign an image
3. Verify the signed image

Visual Studio `$(ProjectDir)` is typically `[WOLFBOOT_ROOT]\tools\keytools`.

-----

### Step 1: wolfBootKeyGenTool Visual Studio Project

Build the project. Generate a new signing key with `keygen.exe`.

```DOS
keygen.exe [ --ed25519 | --ed448 | --ecc256 | --ecc384 | --ecc521 | --rsa2048 | --rsa3072 | --rsa4096 ] ^
           [ -g privkey]     [ -i pubkey] [ -keystoreDir dir]  ^
           [ --id {list}]    [ --der]                        ^
           [ --exportpubkey] [ --nolocalkeys]
```

WARNING: Key Generation will *overwrite* any prior keystore files.

Right-click on `wolfBootKeygenTool` project, typically in:

```text
C:\workspace\wolfBoot-%USERNAME%\tools\keytools
```

Select: Properties - Configuration Properties - Debugging:

```text
Command:           $(TargetPath)
Command Arguments: --ed25519 -g $(ProjectDir)wolfboot_signing_private_key.der   -keystoreDir  $(ProjectDir)
Working Directory: $(ProjectDir)..\..\
```

Replace `$(ProjectDir)` with your desired `keystoreDir` path for keys and firmware locations.
Otherwise the private key will be created in the project directory `[WOLFBOOT_ROOT]\tools\keytools`.

Example:

```DOS
cd $WOLFBOOT_ROOT\tools\keytools

:: cmd       sign     private key
:: ------- --------- -----------------------------------
keygen.exe --ed25519 -g wolfboot_signing_private_key.der
```

Expected output:

```text
wolfBoot KeyGen
Keystore size:        2608
Saving keystore file: C:\workspace\wolfBoot-gojimmypi\tools\keytools\/keystore.c
Selected Keytype:     ECC256
Generating key (type: ECC256)
Associated key file:  C:\workspace\wolfBoot-gojimmypi\tools\keytools\wolfboot_signing_private_key.der
Partition ids mask:   ffffffff
Key type:             ECC256
Public key slot:      0
Done.
```

-----

### Step 2: wolfBootSignTool Visual Studio Project

Build the project. Sign an image with `sign.exe  [OPTIONS]  IMAGE.BIN  KEY.DER  VERSION`.

Right-click on `wolfBootSignTool` project, typically in:

```text
C:\workspace\wolfBoot-%USERNAME%\tools\keytools
```

Select: Properties - Configuration Properties - Debugging:

```text
Command:           $(TargetPath)
Command Arguments: --ed25519 --sha256 "$(ProjectDir)test.bin"  "$(ProjectDir)wolfboot_signing_private_key.der"  1
Working Directory: $(ProjectDir)
```

The `$(ProjectDir)` will typically be something like this, where the `keystore.c` was generated in Step 1 (above):

Example:

```DOS
cd $WOLFBOOT_ROOT\tools\keytools

:: cmd       sign     hash   input     private key                    [version]      [output]
:: ----- --------- -------- -------- -------------------------------- --------- ------------------
sign.exe --ed25519 --sha256 test.bin wolfboot_signing_private_key.der     1     test_v1_signed.bin
```

The last two parameters are optional:

- Version, default is `1`
- Output, default is `[input]_v1_signed.bin`, where the number after the `v` is the version.

Be sure the signing algorithm used here matches the one on the key generation!

Expected output:

```text
wolfBoot KeyTools (Compiled C version)
wolfBoot version 2060000
Update type:          Firmware
Input image:          C:\workspace\wolfBoot-<user>\tools\keytools\test.bin
Selected cipher:      ED25519
Selected hash:        SHA256
Private key:          C:\workspace\wolfBoot-<user>\tools\keytools\wolfboot_signing_private_key.der
Output  image:        C:\workspace\wolfBoot-<user>\tools\keytools\test_v1_signed.bin
Target partition id:  1
Manifest header size: 256
Found ED25519 key
Hashing primary pubkey, size: 32
Calculating SHA256 digest...
Signing the digest...
Sign: 0x01
Output image(s) successfully created.
```

-----

### Step 3. wolfBootTestlib Visual Studio Project

The `IS_TEST_LIB_APP` Macro is needed for the Visual Studio `wolfBootTestLib.vcproj` project file.
See also the related `wolfBootImage.props` file.

Other additional preprocessor macros defined in project file:

```text
__WOLFBOOT;
WOLFBOOT_NO_PARTITIONS;
WOLFBOOT_HASH_SHA256;
WOLFBOOT_SIGN_ECC256;
WOLFSSL_USER_SETTINGS;
WOLFSSL_HAVE_MIN;
WOLFSSL_HAVE_MAX;
```

Build the project. Verify an image with `sign.exe  [OPTIONS]  IMAGE.BIN  KEY.DER  VERSION`.

Right-click on `wolfBootSignTool` project, typically in:

```text
C:\workspace\wolfBoot-%USERNAME%\tools\keytools
```

Select: Properties - Configuration Properties - Debugging:

```text
Command:           $(TargetPath)
Command Arguments: test_v1_signed.bin
Working Directory: $(ProjectDir)
```
