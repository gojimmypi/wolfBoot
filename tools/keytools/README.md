# Key Tools for signing and key generation

## Sign

See [code file `./tools/keytools/sign.c`](./sign.c) and documentation in [docs/Signing.md](../../docs/Signing.md).

## KeyGen and KeyStore

See [code file `./tools/keytools/keygen.c`](./keygen.c) and documentation [docs/keystore.md](../../docs/keystore.md).

## Flash OTP Keystore Generation, Primer, Startup

See documentation [docs/flash-OTP.md](../../docs/flash-OTP.md).

### Keystore Generation

Pack public keys into a single binary (`otp.bin`) formatted the way wolfBoot expects for
provisioning the device’s OTP/NVM keystore. No signing, no encryption—just a correctly laid-out image
with a header plus fixed-size "slots" for each key.

See [code file `./tools/keytools/otp/otp-keystore-gen.c`](./otp/otp-keystore-gen.c)

### Flash OTP Primer

See [code file `./tools/keytools/otp/otp-keystore-primer.c`](./otp/otp-keystore-primer.c)

## Flash OTP Startup

See [code file `./tools/keytools/otp/startup.c`](./otp/startup.c)


## Quick Start (Linux)

```
make wolfboot_signing_private_key.der SIGN=ED25519

# or

./tools/keytools/keygen --ed25519 -g wolfboot_signing_private_key.der
```

## Debugging and Development

### `DEBUG_SIGNTOOL`

Enables additional diagnostic messages that may be useful during development and initial bring-up.

### `WOLFBOOT_SHOW_INCLUDE`

Enables compile-time verbosity to indicate which `user_settings.h` file is being used.

Unless otherwise specified the `keygen` app will create:

1. `./wolfboot_signing_private_key.der` - the private key used for signing.
2. `./keystore.der` - the public key.
3. `src/keystore.c` - the public key, converted to c array.

Common pitfalls: mismatched keystore files in different directories. There should be exactly one
instance of each of the above files in the build tree.

## Strip wolfBoot header

The generated `keystore.der` has an extra 16 bytes of header, can be stripped like this:

```text
dd if=tools/keytools/keystore.der of=raw_xy.bin bs=1 skip=16
64+0 records in
64+0 records out
64 bytes copied, 0.0032417 s, 19.7 kB/s
```

## Strip wolfBoot header from generated public key, convert public key to new SPKI DER file.


The SPKI-format generated by this script can be used to verify an image with `image-peek.py`

```python
./tools/scripts/wolfboot-der-to-spki.py ./tools/keytools/keystore.der
```


## Image Peek

See the [./tools/scripts/image-peek.py](../scripts/image-peek.py).

```
usage: image-peek.py [-h] [--header-size HEADER_SIZE] [--dump-payload OUT]
                     [--verify-hash] [--verify-sig PUBKEY] [--alg {ecdsa-p256,ed25519}] image
```

##

The wolfBoot SPKI DER file can be used to verify an image:

```python
./tools/scripts/image-peek.py ./keytools_test_v1_signed.bin --verify-sig ./tools/keytools/keystore_spki.der --alg ecdsa-p256
```

